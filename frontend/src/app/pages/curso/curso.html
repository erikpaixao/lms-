<div class="main-container">
  <mat-card *ngIf="curso" class="course-card">
    <mat-card-header class="mat-card-header">
      <mat-card-title>
        <div *ngIf="!isEditMode(); else editModeTitle">
          <h1 class="course-name">{{ curso.nome }}</h1>
        </div>
        <ng-template #editModeTitle>
          <form
            [formGroup]="editCourseForm"
            (ngSubmit)="onEditCourseSubmit()"
            class="flex-container"
          >
            <mat-form-field appearance="outline" class="flex-grow">
              <mat-label>Nome do Curso</mat-label>
              <input matInput formControlName="nome" required />
              <mat-error
                *ngIf="editCourseForm.get('nome')?.hasError('required')"
              >
                O nome do curso é obrigatório.
              </mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline" class="flex-grow">
              <mat-label>Data de Início</mat-label>
              <input
                matInput
                [matDatepicker]="picker"
                formControlName="dataInicio"
                required
              />
              <mat-hint>DD/MM/YYYY</mat-hint>
              <mat-datepicker-toggle
                matIconSuffix
                [for]="picker"
              ></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              <mat-error
                *ngIf="editCourseForm.get('dataInicio')?.hasError('required')"
              >
                A data de início é obrigatória.
              </mat-error>
            </mat-form-field>
            <button
              mat-mini-fab
              color="primary"
              type="submit"
              [disabled]="editCourseForm.invalid"
            >
              <mat-icon>save</mat-icon>
            </button>
            <button mat-mini-fab (click)="toggleEditMode()" type="button">
              <mat-icon>cancel</mat-icon>
            </button>
          </form>
        </ng-template>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content class="mat-card-content">
      <div *ngIf="!isEditMode()" class="header-details-container">
        <p class="text-sm text-gray-500">
          Início: {{ curso.dataInicio | date : "dd/MM/yyyy" }} &bull; Fim:
          {{ curso.dataFim | date : "dd/MM/yyyy" }}
        </p>
        <button
          mat-raised-button
          color="primary"
          (click)="toggleEditMode()"
          authPermission="ADMIN"
        >
          Editar Curso
        </button>
      </div>

      <mat-divider></mat-divider>

      <h2 class="section-title">Tarefas</h2>
      <div
        *ngIf="tarefas?.length > 0; else noTasks"
        class="task-list-container"
      >
        <table class="task-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Descrição</th>
              <th>Categoria</th>
              <th>Tempo Gasto</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let tarefa of tarefas">
              <td>{{ tarefa.dataTarefa | date : "dd/MM/yyyy  HH:mm" }}</td>
              <td>{{ tarefa.descricao }}</td>
              <td>{{ tarefa.categoria }}</td>
              <td>{{ tarefa.tempoGasto | date : "HH:mm" }}</td>
              <td>
                <button
                  mat-flat-button
                  color="accent"
                  (click)="incrementarTempo(tarefa)"
                >
                  +30 min
                </button>
                <button
                  mat-flat-button
                  color="warn"
                  (click)="removerTarefa(tarefa)"
                >
                  Remover
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #noTasks>
        <div class="no-tasks-message">
          <p>Nenhuma tarefa adicionada ainda.</p>
        </div>
      </ng-template>

      <mat-divider class="my-4"></mat-divider>

      <h2 class="section-title">Adicionar Nova Tarefa</h2>
      <form [formGroup]="novaTarefaForm" (ngSubmit)="onAddTaskSubmit()">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Descrição da Tarefa</mat-label>
          <input matInput formControlName="descricao" required />
          <mat-error
            *ngIf="novaTarefaForm.get('descricao')?.hasError('required')"
          >
            A descrição da tarefa é obrigatória.
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" class="w-full mt-4">
          <mat-label>Categoria</mat-label>
          <mat-select formControlName="categoria" required>
            <mat-option *ngFor="let cat of categorias" [value]="cat.id">
              {{ cat.nome }}
            </mat-option>
          </mat-select>
          <mat-error
            *ngIf="novaTarefaForm.get('categoria')?.hasError('required')"
          >
            A categoria é obrigatória.
          </mat-error>
        </mat-form-field>
        <button
          mat-raised-button
          color="primary"
          type="submit"
          class="w-full mt-4"
          [disabled]="novaTarefaForm.invalid"
        >
          Adicionar Tarefa
        </button>
      </form>
    </mat-card-content>
  </mat-card>
  <div *ngIf="!curso" class="loading-message">
    <p>Carregando dados do curso...</p>
  </div>
</div>
